# Security Policy

This document describes the security practices, policies, and procedures for the Middleware Automation Platform.

## Supported Versions

| Version | Supported          |
| ------- | ------------------ |
| main    | :white_check_mark: |

Security updates are applied to the main branch. We recommend always using the latest version.

## Reporting a Vulnerability

If you discover a security vulnerability in this project, please report it responsibly.

**Contact:** security@example.com

When reporting, please include:

- Description of the vulnerability
- Steps to reproduce the issue
- Potential impact assessment
- Any suggested remediation (optional)

**Response Timeline:**

- Acknowledgment within 48 hours
- Initial assessment within 7 days
- Regular updates on remediation progress

Please do not disclose the vulnerability publicly until we have had an opportunity to address it.

## Security Practices

This project implements security controls across multiple layers. The following sections document the security measures in place.

### Secrets Management

**No secrets are stored in version control.** All credentials are managed through secure storage mechanisms:

| Component | Secret Storage | Notes |
|-----------|----------------|-------|
| Grafana (AWS) | AWS Secrets Manager | Auto-generated by Terraform |
| AWX | Kubernetes Secret | Manual creation required |
| Jenkins | Kubernetes Secret / Environment Variable | Platform-dependent |
| Liberty Passwords | Ansible Vault | AES-encrypted at rest |
| Database | AWS Secrets Manager | Auto-generated by Terraform |

For complete credential setup instructions, see [docs/CREDENTIAL_SETUP.md](docs/CREDENTIAL_SETUP.md).

### Container Security

The container build process excludes sensitive files using `.dockerignore`:

- SSH keys (`id_rsa*`, `id_ed25519*`, `*.pub`)
- TLS certificates and keystores (`*.pem`, `*.key`, `*.crt`, `*.p12`, `*.jks`)
- Environment files (`*.env`, `.env*`)
- AWS credentials (`.aws/`)
- Secrets directories (`secrets/`, `credentials/`, `**/secrets/`)
- Terraform state files (`*.tfstate*`)
- Ansible configuration (`ansible/`, `automated/`)

### Ansible Security Controls

**Password Encoding:** Liberty passwords are never stored in plaintext on target servers. The deployment process:

1. Retrieves encrypted passwords from Ansible Vault
2. Encodes them using Liberty's `securityUtility` with AES encryption
3. Writes only encoded passwords (e.g., `{aes}AJk3N...`) to `server.xml`
4. Liberty decrypts passwords automatically at runtime

**Log Protection:** All tasks handling sensitive data use `no_log: true` to prevent credential exposure in Ansible output:

- Password encoding tasks
- Secrets Manager retrieval
- Server configuration deployment
- SSL certificate generation

**Password Validation:** The Liberty role enforces password complexity:

- Keystore password: minimum 16 characters, no common defaults
- Admin password: minimum 12 characters, no common defaults
- Rejected passwords: `changeit`, `password`, `changeme`, `admin`, `liberty`

### AWS Security Controls

#### IAM Least Privilege

IAM policies use scoped resource ARNs rather than wildcards where supported:

- **ECS Execution Role:** Scoped to specific ECR repository, CloudWatch log group, and Secrets Manager secrets
- **ECS Task Role:** Scoped to specific CloudWatch log group
- **RDS Monitoring Role:** Uses AWS managed policy with service-specific scope

Wildcards are only used where AWS requires them (e.g., `ecr:GetAuthorizationToken`, SSM Session Manager).

#### Network Security

Security groups follow the principle of least privilege:

- **Liberty servers:** Accept traffic only from ALB and VPC CIDR (for Ansible/monitoring)
- **RDS:** Accept traffic only from Liberty security group on port 5432
- **ElastiCache:** Accept traffic only from Liberty security group on port 6379
- **Bastion:** SSH access restricted to explicitly allowed CIDR blocks
- **Management interfaces:** Admin console (9443) restricted to `management_allowed_cidrs`

#### Encryption

- **Data at rest:** RDS storage encryption enabled (`storage_encrypted = true`)
- **Data in transit:** HTTPS for ALB, TLS for database connections
- **Secrets:** AWS Secrets Manager with KMS encryption

#### Database Security

- RDS instances are not publicly accessible (`publicly_accessible = false`)
- Deployed in private subnets only
- Final snapshots required before deletion
- Performance Insights enabled for security monitoring

### Terraform State Security

- Remote state stored in S3 with versioning enabled
- State locking via DynamoDB prevents concurrent modifications
- State files are never committed to version control
- Sensitive values marked with `sensitive = true` in outputs

### CI/CD Security

When using GitHub Actions (recommended):

- Use OIDC for AWS authentication (no long-lived access keys)
- Environment protection rules for production deployments
- Approval requirements for sensitive operations

## Security Checklist for Deployments

Before deploying to production, verify:

- [ ] `management_allowed_cidrs` is set to specific IP addresses (not `0.0.0.0/0`)
- [ ] `allowed_ssh_cidr_blocks` is set to specific IP addresses or empty
- [ ] All passwords meet minimum complexity requirements
- [ ] Ansible Vault password is stored securely (not in version control)
- [ ] AWS credentials use short-lived tokens or IAM roles
- [ ] Terraform state backend is configured with encryption
- [ ] Container images are pulled from trusted registries only

## Secure Development Guidelines

When contributing to this project:

1. **Never commit secrets** - Use environment variables, Ansible Vault, or Secrets Manager
2. **Review security groups** - Verify no unintended `0.0.0.0/0` ingress rules
3. **Use `no_log: true`** - For any Ansible task handling credentials
4. **Validate IAM policies** - Scope to specific resources where possible
5. **Update dependencies** - Keep container base images and dependencies current
6. **Run security scans** - Use `tfsec`, `checkov`, or similar tools before merging

## References

- [docs/CREDENTIAL_SETUP.md](docs/CREDENTIAL_SETUP.md) - Complete credential configuration guide
- [docs/troubleshooting/terraform-aws.md](docs/troubleshooting/terraform-aws.md) - AWS troubleshooting including IAM issues
- [automated/ansible/roles/liberty/README.md](automated/ansible/roles/liberty/README.md) - Liberty role security documentation
