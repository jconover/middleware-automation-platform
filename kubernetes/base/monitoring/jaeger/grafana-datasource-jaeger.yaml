# =============================================================================
# Grafana Datasource for Jaeger Distributed Tracing
# =============================================================================
# This ConfigMap provisions the Jaeger datasource in Grafana for trace visualization.
# It enables correlation between metrics, logs, and traces in Grafana dashboards.
#
# Usage:
#   1. Deploy this ConfigMap to the monitoring namespace
#   2. Restart Grafana to pick up the new datasource
#   3. Access traces via Explore or linked from metrics/logs
#
# Prerequisites:
#   - Jaeger deployed in tracing namespace
#   - Grafana installed via kube-prometheus-stack
#
# Features:
#   - Trace-to-logs correlation with Loki
#   - Trace-to-metrics correlation with Prometheus
#   - Service map visualization
#   - Span attribute filtering
#
# =============================================================================
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasource-jaeger
  namespace: monitoring
  labels:
    grafana_datasource: "1"
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: datasource
    app.kubernetes.io/part-of: middleware-platform
data:
  jaeger-datasource.yaml: |
    apiVersion: 1
    datasources:
      - name: Jaeger
        type: jaeger
        uid: jaeger
        access: proxy
        url: http://jaeger-query.tracing.svc.cluster.local:16686
        isDefault: false
        editable: false
        jsonData:
          # Enable trace-to-logs correlation
          tracesToLogs:
            datasourceUid: loki
            tags:
              - key: "service.name"
                value: "service_name"
              - key: "trace.id"
                value: "traceId"
            mappedTags:
              - key: "service.name"
                value: "service_name"
            mapTagNamesEnabled: true
            spanStartTimeShift: "-1h"
            spanEndTimeShift: "1h"
            filterByTraceID: true
            filterBySpanID: false

          # Enable trace-to-metrics correlation
          tracesToMetrics:
            datasourceUid: prometheus
            tags:
              - key: "service.name"
                value: "service"
            queries:
              - name: "Request Rate"
                query: "sum(rate(http_server_requests_total{service=\"$${__tags.service}\"}[5m]))"
              - name: "Error Rate"
                query: "sum(rate(http_server_requests_total{service=\"$${__tags.service}\", status=~\"5..\"}[5m]))"
              - name: "Latency P95"
                query: "histogram_quantile(0.95, sum(rate(http_server_request_duration_seconds_bucket{service=\"$${__tags.service}\"}[5m])) by (le))"

          # Node graph settings for service map
          nodeGraph:
            enabled: true

          # Enable service map
          serviceMap:
            datasourceUid: prometheus

          # Search configuration
          search:
            hide: false

          # Span bar settings
          spanBar:
            type: Tag
            tag: http.status_code
