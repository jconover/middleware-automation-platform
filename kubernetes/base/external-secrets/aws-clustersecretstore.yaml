# =============================================================================
# AWS Secrets Manager ClusterSecretStore
# =============================================================================
# This ClusterSecretStore enables External Secrets Operator to fetch secrets
# from AWS Secrets Manager. It's cluster-scoped, so it can be used by
# ExternalSecrets in any namespace.
#
# Prerequisites:
#   1. External Secrets Operator installed in the cluster
#   2. AWS IAM permissions configured (IRSA for EKS, or access keys for local)
#
# The middleware-automation-platform uses these AWS secrets:
#   - mw-prod/database/credentials    (DB username, password, host, port)
#   - mw-prod/redis/auth-token        (Redis AUTH token, host, port)
#   - mw-prod/monitoring/grafana-credentials (Grafana admin credentials)
# =============================================================================
---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: middleware-platform
  annotations:
    description: "ClusterSecretStore for AWS Secrets Manager integration"
spec:
  provider:
    aws:
      service: SecretsManager
      # AWS Region where secrets are stored
      # This should match your Terraform deployment region
      region: us-east-1
      # =======================================================================
      # Authentication Options (choose ONE)
      # =======================================================================
      #
      # Option 1: IRSA (Recommended for EKS)
      # -------------------------------------
      # When using IRSA, the service account is annotated with the IAM role ARN.
      # No additional auth configuration is needed here - just ensure the ESO
      # service account has the correct annotation:
      #   eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/external-secrets-role
      #
      # Option 2: AWS Access Keys (for non-EKS or local development)
      # -------------------------------------------------------------
      # Uncomment the auth section below and create the secret:
      #   kubectl create secret generic aws-credentials \
      #     --namespace external-secrets \
      #     --from-literal=access-key=YOUR_ACCESS_KEY \
      #     --from-literal=secret-access-key=YOUR_SECRET_KEY
      #
      # auth:
      #   secretRef:
      #     accessKeyIDSecretRef:
      #       name: aws-credentials
      #       namespace: external-secrets
      #       key: access-key
      #     secretAccessKeySecretRef:
      #       name: aws-credentials
      #       namespace: external-secrets
      #       key: secret-access-key
      # =======================================================================
  # Conditions for store health check
  conditions:
    - type: Ready
      status: "True"
      reason: "ConfiguredCorrectly"
      message: "AWS Secrets Manager connection configured"
