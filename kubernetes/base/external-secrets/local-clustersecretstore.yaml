# =============================================================================
# Local Development ClusterSecretStore
# =============================================================================
# This ClusterSecretStore uses the Kubernetes secrets backend for local
# development and testing. It reads secrets from a "source" namespace and
# allows ExternalSecrets to reference them.
#
# This approach is useful for:
#   - Local development without cloud provider access
#   - Testing External Secrets workflows
#   - Homelab/on-premises deployments without Vault
#
# How it works:
#   1. Create "source" secrets in the 'secrets-source' namespace
#   2. ExternalSecrets reference this store and pull secrets from the source
#   3. ESO creates the actual secrets in the target namespaces
#
# Setup:
#   kubectl create namespace secrets-source
#   kubectl create secret generic liberty-db-credentials \
#     --namespace secrets-source \
#     --from-literal=username=liberty \
#     --from-literal=password='your-password' \
#     --from-literal=host=postgres.database.svc.cluster.local \
#     --from-literal=port=5432 \
#     --from-literal=dbname=libertydb
# =============================================================================
---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: kubernetes-secrets
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: middleware-platform
  annotations:
    description: "ClusterSecretStore for local development using Kubernetes secrets"
spec:
  provider:
    kubernetes:
      # Reference secrets in the source namespace
      remoteNamespace: secrets-source
      server:
        # Use in-cluster configuration
        url: "https://kubernetes.default.svc"
        caProvider:
          type: ConfigMap
          name: kube-root-ca.crt
          namespace: kube-system
          key: ca.crt
      # Service account with permissions to read secrets from source namespace
      auth:
        serviceAccount:
          name: external-secrets-local
          namespace: external-secrets
  conditions:
    - type: Ready
      status: "True"
      reason: "ConfiguredCorrectly"
      message: "Kubernetes secrets backend configured"

---
# =============================================================================
# Service Account and RBAC for Local Secret Store
# =============================================================================
# This service account needs permission to read secrets from the source namespace
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-local
  namespace: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: middleware-platform

---
# Role to read secrets in the source namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: external-secrets-source-reader
  namespace: secrets-source
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: middleware-platform
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch"]

---
# Bind the role to the service account
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: external-secrets-source-reader
  namespace: secrets-source
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: middleware-platform
subjects:
  - kind: ServiceAccount
    name: external-secrets-local
    namespace: external-secrets
roleRef:
  kind: Role
  name: external-secrets-source-reader
  apiGroup: rbac.authorization.k8s.io
