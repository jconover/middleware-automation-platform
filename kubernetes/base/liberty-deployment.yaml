---
# Open Liberty Kubernetes Deployment
# Security-hardened configuration following CIS Kubernetes Benchmark
apiVersion: apps/v1
kind: Deployment
metadata:
  name: liberty-app
  labels:
    app: liberty
    app.kubernetes.io/name: liberty
    app.kubernetes.io/component: application-server
    app.kubernetes.io/part-of: middleware-platform
    app.kubernetes.io/managed-by: kubectl
  annotations:
    # Security compliance annotations
    security.kubernetes.io/pod-security-standards: restricted
    description: "Open Liberty application server with enterprise security hardening"
spec:
  replicas: 3
  revisionHistoryLimit: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: liberty
  template:
    metadata:
      labels:
        app: liberty
        app.kubernetes.io/name: liberty
        app.kubernetes.io/version: "1.0.0"
        app.kubernetes.io/component: application-server
        app.kubernetes.io/part-of: middleware-platform
      annotations:
        # Prometheus monitoring
        prometheus.io/scrape: "true"
        prometheus.io/port: "9080"
        prometheus.io/path: "/metrics"
        # Security annotations
        container.apparmor.security.beta.kubernetes.io/liberty: runtime/default
        # OpenTelemetry auto-instrumentation annotation
        # Requires OTEL Operator: kubectl apply -f https://github.com/open-telemetry/opentelemetry-operator/releases/latest/download/opentelemetry-operator.yaml
        # Then create Instrumentation CR in tracing namespace (see otel-instrumentation.yaml)
        instrumentation.opentelemetry.io/inject-java: "tracing/liberty-instrumentation"
    spec:
      # Pod-level security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault

      # Prevent pods from being scheduled on the same node
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: liberty
                topologyKey: kubernetes.io/hostname

      # Distribute pods across availability zones and nodes
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: liberty
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app: liberty

      # Service account with minimal permissions
      serviceAccountName: liberty-app
      automountServiceAccountToken: false

      # DNS policy for security
      dnsPolicy: ClusterFirst

      # Graceful termination
      terminationGracePeriodSeconds: 60

      containers:
        - name: liberty
          image: docker.io/jconover/liberty-app:1.0.0
          imagePullPolicy: Always

          # Container-level security context (defense in depth)
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault

          ports:
            - name: http
              containerPort: 9080
              protocol: TCP
            - name: https
              containerPort: 9443
              protocol: TCP

          env:
            - name: WLP_LOGGING_CONSOLE_FORMAT
              value: "JSON"
            - name: WLP_LOGGING_CONSOLE_LOGLEVEL
              value: "info"
            # =================================================================
            # Database Credentials (from liberty-secrets managed by ESO)
            # =================================================================
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: liberty-secrets
                  key: db.host
                  optional: true
            - name: DB_PORT
              valueFrom:
                secretKeyRef:
                  name: liberty-secrets
                  key: db.port
                  optional: true
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: liberty-secrets
                  key: db.name
                  optional: true
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: liberty-secrets
                  key: db.username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: liberty-secrets
                  key: db.password
            # =================================================================
            # Redis Credentials (from liberty-secrets managed by ESO)
            # =================================================================
            - name: REDIS_HOST
              valueFrom:
                secretKeyRef:
                  name: liberty-secrets
                  key: redis.host
                  optional: true
            - name: REDIS_PORT
              valueFrom:
                secretKeyRef:
                  name: liberty-secrets
                  key: redis.port
                  optional: true
            - name: REDIS_AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: liberty-secrets
                  key: redis.auth
                  optional: true
            # JVM security settings
            - name: JVM_ARGS
              value: "-XX:+UseContainerSupport -Dcom.ibm.ws.logging.console.format=json"
            # =================================================================
            # OpenTelemetry Configuration for Distributed Tracing
            # These are used if OTEL Operator auto-instrumentation is not active
            # =================================================================
            - name: OTEL_SERVICE_NAME
              value: "liberty-app"
            - name: OTEL_RESOURCE_ATTRIBUTES
              value: "service.namespace=middleware-platform,deployment.environment=local-kubernetes"
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: "http://otel-collector.tracing.svc.cluster.local:4317"
            - name: OTEL_TRACES_EXPORTER
              value: "otlp"
            - name: OTEL_METRICS_EXPORTER
              value: "none"
            - name: OTEL_LOGS_EXPORTER
              value: "none"
            - name: OTEL_PROPAGATORS
              value: "tracecontext,baggage"

          resources:
            requests:
              cpu: "500m"
              memory: "1Gi"
              ephemeral-storage: "256Mi"
            limits:
              cpu: "2000m"
              memory: "2Gi"
              ephemeral-storage: "1Gi"

          startupProbe:
            httpGet:
              path: /health/started
              port: http
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30
            successThreshold: 1

          livenessProbe:
            httpGet:
              path: /health/live
              port: http
              scheme: HTTP
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1

          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
              scheme: HTTP
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1

          # Graceful shutdown: allow load balancer to drain connections before SIGTERM
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - sleep 15

          volumeMounts:
            - name: config
              mountPath: /config/server.xml
              subPath: server.xml
              readOnly: true
            # Writable directories required by Liberty
            - name: liberty-logs
              mountPath: /logs
            - name: liberty-tmp
              mountPath: /tmp
            - name: liberty-output
              mountPath: /opt/ol/wlp/output/defaultServer

      volumes:
        - name: config
          configMap:
            name: liberty-config
            defaultMode: 0440
        # EmptyDir volumes for writable paths (ephemeral)
        - name: liberty-logs
          emptyDir:
            sizeLimit: 500Mi
        - name: liberty-tmp
          emptyDir:
            sizeLimit: 256Mi
        - name: liberty-output
          emptyDir:
            sizeLimit: 512Mi

---
apiVersion: v1
kind: Service
metadata:
  name: liberty-service
  labels:
    app: liberty
    app.kubernetes.io/name: liberty
    app.kubernetes.io/component: application-server
    app.kubernetes.io/part-of: middleware-platform
  annotations:
    description: "Liberty application service endpoint"
spec:
  type: ClusterIP
  sessionAffinity: None
  ports:
    - name: http
      port: 9080
      targetPort: http
      protocol: TCP
    - name: https
      port: 9443
      targetPort: https
      protocol: TCP
  selector:
    app: liberty

---
# =============================================================================
# HPA Configuration - See liberty-hpa.yaml
# =============================================================================
# The HorizontalPodAutoscaler is now defined in a separate file (liberty-hpa.yaml)
# with support for custom metrics including:
#   - http_requests_per_second (target: 1000 RPS per pod)
#   - http_request_duration_seconds_p95 (target: 500ms)
#   - CPU and memory utilization (baseline metrics)
#
# Prerequisites for custom metrics:
#   - prometheus-adapter deployment (kubernetes/base/monitoring/prometheus-adapter/)
#   - ServiceMonitor collecting Liberty metrics
#
# Apply: kubectl apply -f kubernetes/base/liberty-hpa.yaml
# =============================================================================

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: liberty-pdb
  labels:
    app: liberty
    app.kubernetes.io/name: liberty
    app.kubernetes.io/component: application-server
    app.kubernetes.io/part-of: middleware-platform
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: liberty

---
# =============================================================================
# ServiceAccount with Explicit Least-Privilege RBAC
# =============================================================================
# Security Design:
#   - automountServiceAccountToken: false - prevents automatic token mounting
#   - Empty Role with no rules - explicit deny-all for Kubernetes API access
#   - RoleBinding documents the security posture for audit purposes
#
# This ServiceAccount intentionally has NO permissions. The Liberty application
# does not require Kubernetes API access. If future requirements change:
#   1. Document the specific API resources needed
#   2. Add minimal rules to the Role (not ClusterRole)
#   3. Follow least-privilege: only verbs and resources actually required
# =============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: liberty-app
  labels:
    app: liberty
    app.kubernetes.io/name: liberty
    app.kubernetes.io/component: application-server
    app.kubernetes.io/part-of: middleware-platform
  annotations:
    description: "Minimal service account for Liberty pods - no Kubernetes API access"
    security.kubernetes.io/rbac-posture: "deny-all"
automountServiceAccountToken: false

---
# Role with empty rules - explicit deny-all
# This Role exists to document that Liberty pods have NO Kubernetes API permissions.
# An empty rules array means no API access is granted.
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: liberty-app-role
  labels:
    app: liberty
    app.kubernetes.io/name: liberty
    app.kubernetes.io/component: application-server
    app.kubernetes.io/part-of: middleware-platform
  annotations:
    description: "Intentionally empty role - Liberty requires no Kubernetes API access"
    security.kubernetes.io/rbac-posture: "deny-all"
# Empty rules array = no permissions granted
# This is intentional least-privilege security
rules: []

---
# RoleBinding to associate the empty Role with the ServiceAccount
# This binding completes the RBAC chain and makes the security posture auditable.
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: liberty-app-rolebinding
  labels:
    app: liberty
    app.kubernetes.io/name: liberty
    app.kubernetes.io/component: application-server
    app.kubernetes.io/part-of: middleware-platform
  annotations:
    description: "Binds empty role to liberty-app SA - documents deny-all posture"
    security.kubernetes.io/rbac-posture: "deny-all"
subjects:
  - kind: ServiceAccount
    name: liberty-app
roleRef:
  kind: Role
  name: liberty-app-role
  apiGroup: rbac.authorization.k8s.io

---
# NetworkPolicy: Restrict ingress to only allowed sources
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: liberty-network-policy
  labels:
    app: liberty
    app.kubernetes.io/name: liberty
    app.kubernetes.io/component: application-server
    app.kubernetes.io/part-of: middleware-platform
spec:
  podSelector:
    matchLabels:
      app: liberty
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: traefik
      ports:
        - protocol: TCP
          port: 9080
        - protocol: TCP
          port: 9443
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 9080
    # Allow inter-pod communication within the same app
    - from:
        - podSelector:
            matchLabels:
              app: liberty
      ports:
        - protocol: TCP
          port: 9080
        - protocol: TCP
          port: 9443
  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow database connections (PostgreSQL)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: database
      ports:
        - protocol: TCP
          port: 5432
    # Allow trace export to OpenTelemetry Collector in tracing namespace
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: tracing
          podSelector:
            matchLabels:
              app: otel-collector
      ports:
        - protocol: TCP
          port: 4317
        - protocol: TCP
          port: 4318
    # Allow external HTTPS (for external API calls if needed)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

---
# Resource Quota for the namespace (apply to liberty namespace)
apiVersion: v1
kind: ResourceQuota
metadata:
  name: liberty-resource-quota
  labels:
    app: liberty
    app.kubernetes.io/name: liberty
    app.kubernetes.io/part-of: middleware-platform
spec:
  hard:
    requests.cpu: "10"
    requests.memory: "20Gi"
    limits.cpu: "40"
    limits.memory: "40Gi"
    pods: "20"
    persistentvolumeclaims: "10"

---
# LimitRange for default resource constraints
apiVersion: v1
kind: LimitRange
metadata:
  name: liberty-limit-range
  labels:
    app: liberty
    app.kubernetes.io/name: liberty
    app.kubernetes.io/part-of: middleware-platform
spec:
  limits:
    - type: Container
      default:
        cpu: "1000m"
        memory: "1Gi"
      defaultRequest:
        cpu: "250m"
        memory: "512Mi"
      min:
        cpu: "100m"
        memory: "128Mi"
      max:
        cpu: "4000m"
        memory: "4Gi"
    - type: PersistentVolumeClaim
      min:
        storage: "1Gi"
      max:
        storage: "50Gi"
