---
# ClusterIssuer for Let's Encrypt (Staging)
# Use staging for testing to avoid rate limits
#
# Prerequisites:
#   - cert-manager installed in the cluster
#   - Email address configured for certificate expiration notifications
#
# Installation:
#   kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.0/cert-manager.yaml
#   kubectl wait --for=condition=Available deployment --all -n cert-manager --timeout=300s
#
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: cluster-issuer
    app.kubernetes.io/part-of: middleware-platform
spec:
  acme:
    # Let's Encrypt staging server (use for testing - no rate limits)
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    # Email address for certificate expiration notifications
    # IMPORTANT: Replace with your actual email address
    email: admin@example.com
    # Secret to store the ACME account private key
    privateKeySecretRef:
      name: letsencrypt-staging-account-key
    # HTTP-01 challenge solver using nginx ingress
    solvers:
      - http01:
          ingress:
            class: nginx
            # Optional: specify ingress template annotations
            # ingressTemplate:
            #   metadata:
            #     annotations:
            #       kubernetes.io/ingress.class: nginx

---
# ClusterIssuer for Let's Encrypt (Production)
# Use this for production after testing with staging
#
# IMPORTANT: Let's Encrypt production has strict rate limits:
#   - 50 Certificates per Registered Domain per week
#   - 5 Duplicate Certificates per week
#   - 5 Failed Validations per hour
#
# Always test with staging first!
#
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-production
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: cluster-issuer
    app.kubernetes.io/part-of: middleware-platform
spec:
  acme:
    # Let's Encrypt production server
    server: https://acme-v02.api.letsencrypt.org/directory
    # Email address for certificate expiration notifications
    # IMPORTANT: Replace with your actual email address
    email: admin@example.com
    # Secret to store the ACME account private key
    privateKeySecretRef:
      name: letsencrypt-production-account-key
    # HTTP-01 challenge solver using nginx ingress
    solvers:
      - http01:
          ingress:
            class: nginx

---
# ClusterIssuer for Self-Signed Certificates
# Use for development/testing environments without external CA requirements
# Generates a self-signed CA and issues certificates from it
#
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-issuer
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: cluster-issuer
    app.kubernetes.io/part-of: middleware-platform
spec:
  selfSigned: {}

---
# CA Certificate for internal PKI
# This creates a self-signed CA that can issue certificates for internal services
# Useful for development and homelab environments
#
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: liberty-ca
  namespace: cert-manager
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: ca-certificate
    app.kubernetes.io/part-of: middleware-platform
spec:
  isCA: true
  commonName: liberty-ca
  secretName: liberty-ca-secret
  duration: 87600h  # 10 years
  renewBefore: 8760h  # 1 year before expiry
  privateKey:
    algorithm: RSA
    size: 4096
  issuerRef:
    name: selfsigned-issuer
    kind: ClusterIssuer
    group: cert-manager.io

---
# ClusterIssuer using the internal CA
# Issues certificates signed by the liberty-ca
#
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: liberty-ca-issuer
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: cluster-issuer
    app.kubernetes.io/part-of: middleware-platform
spec:
  ca:
    secretName: liberty-ca-secret
