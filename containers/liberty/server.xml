<?xml version="1.0" encoding="UTF-8"?>
<server description="Containerized Open Liberty">
    <featureManager>
        <feature>restfulWS-3.1</feature>
        <feature>jsonb-3.0</feature>
        <feature>cdi-4.0</feature>
        <feature>mpHealth-4.0</feature>
        <feature>mpMetrics-5.0</feature>
        <feature>mpConfig-3.0</feature>
        <feature>jdbc-4.3</feature>
        <feature>ssl-1.0</feature>
    </featureManager>

    <httpEndpoint id="defaultHttpEndpoint" host="*"
                  httpPort="9080"
                  httpsPort="9443">
        <!-- Limit POST body size to 1MB to prevent DoS attacks -->
        <httpOptions maxPostSize="1048576" />
    </httpEndpoint>

    <!-- ===================================================================== -->
    <!-- SSL/TLS Configuration                                                 -->
    <!-- ===================================================================== -->
    <!--
         HTTPS on port 9443 requires a keystore to be mounted at runtime.

         For container deployments:
         1. Mount your PKCS12 keystore to /config/resources/security/key.p12
         2. Set environment variable KEYSTORE_PASSWORD with the keystore password

         Example:
           podman run -d \
             -v /path/to/key.p12:/config/resources/security/key.p12:ro \
             -e KEYSTORE_PASSWORD=your_password \
             liberty-app:1.0.0

         For development/testing without HTTPS, access the application via port 9080.
         Liberty will start successfully but HTTPS will be unavailable until configured.
    -->
    <ssl id="defaultSSLConfig" keyStoreRef="defaultKeyStore" />

    <keyStore id="defaultKeyStore"
              location="${server.config.dir}/resources/security/key.p12"
              password="${env.KEYSTORE_PASSWORD}"
              type="PKCS12" />

    <mpHealth authentication="false"/>

    <!-- ===================================================================== -->
    <!-- Metrics Endpoint Security                                             -->
    <!-- ===================================================================== -->
    <!--
         SECURITY NOTE: Metrics authentication is intentionally disabled.

         WHY AUTHENTICATION IS DISABLED:
         - Prometheus requires unauthenticated scraping by default
         - MicroProfile Metrics 5.0+ with authentication requires complex
           Prometheus configuration (bearer tokens, TLS client certs)
         - The operational complexity outweighs the security benefit given
           the network-level protections in place

         SECURITY LAYERS PROTECTING /metrics:
         1. AWS ALB Rule - Blocks public access to /metrics (returns 403)
            See: automated/terraform/environments/prod-aws/loadbalancer.tf
            Rule: path-pattern "/metrics" -> fixed-response 403

         2. Security Groups - Only ALB and monitoring server can reach Liberty
            - ECS tasks in private subnets, no public IP
            - EC2 instances in private subnets
            - Prometheus server whitelisted in security group

         3. Kubernetes NetworkPolicy (local cluster)
            - Only prometheus namespace can access /metrics
            See: kubernetes/base/monitoring/liberty-networkpolicy.yaml

         4. VPC Network Isolation
            - Liberty runs in private subnets (no internet ingress)
            - NAT gateway for egress only

         WHEN TO ENABLE AUTHENTICATION:
         - If metrics must traverse untrusted networks
         - If compliance requires authenticated endpoints
         - If using a metrics aggregator that supports auth

         TO ENABLE: Set authentication="true" and configure:
         - <quickStartSecurity userName="metrics" userPassword="${env.METRICS_PASSWORD}"/>
         - Configure Prometheus with basic_auth in scrape_config
    -->
    <mpMetrics authentication="false"/>

    <logging consoleLogLevel="INFO" consoleFormat="JSON"/>

    <!-- Auto-deploy WAR files from apps directory -->
    <webApplication id="sample-app" location="sample-app.war" contextRoot="/sample-app"/>
</server>
