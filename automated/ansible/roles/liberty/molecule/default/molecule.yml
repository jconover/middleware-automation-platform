---
# =============================================================================
# Molecule Configuration for Liberty Role
# =============================================================================
# This configuration defines the test environment for the Liberty Ansible role.
# Uses Docker with Ubuntu 22.04 to simulate a production-like environment.
# =============================================================================

dependency:
  name: galaxy

driver:
  name: docker

platforms:
  - name: liberty-test-instance
    image: ubuntu:22.04
    pre_build_image: true
    privileged: true
    command: /lib/systemd/systemd
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    tmpfs:
      - /run
      - /tmp
    capabilities:
      - SYS_ADMIN
    # Expose Liberty ports for testing
    published_ports:
      - "9080:9080"
      - "9443:9443"

provisioner:
  name: ansible
  inventory:
    host_vars:
      liberty-test-instance:
        # Required Liberty configuration
        liberty_version: "24.0.0.4"
        liberty_install_dir: "/opt/wlp"
        liberty_server_name: "defaultServer"
        liberty_user: "liberty"
        liberty_java_version: "17"
        liberty_http_port: 9080
        liberty_https_port: 9443
        liberty_admin_user: "admin"
        # Test passwords meeting validation requirements
        # Keystore password: minimum 16 characters
        liberty_keystore_password: "MoleculeTest#2024$KeyStore!"
        # Admin password: minimum 12 characters
        liberty_admin_password: "MoleculeAdmin#2024"
        # Environment settings for test
        env_name: "test"
  playbooks:
    prepare: prepare.yml
    converge: converge.yml
    verify: verify.yml
  config_options:
    defaults:
      callbacks_enabled: profile_tasks
      stdout_callback: yaml
    ssh_connection:
      pipelining: true

verifier:
  name: ansible

scenario:
  name: default
  test_sequence:
    - dependency
    - cleanup
    - destroy
    - syntax
    - create
    - prepare
    - converge
    - idempotence
    - verify
    - cleanup
    - destroy
