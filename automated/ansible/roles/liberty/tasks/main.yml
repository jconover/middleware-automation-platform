---
# =============================================================================
# Liberty Role - Main Tasks
# =============================================================================

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - liberty_version is defined
      - liberty_install_dir is defined
    fail_msg: "Required Liberty variables not defined"

# =============================================================================
# SECURITY: Validate security-critical variables
# These variables MUST be set via Ansible Vault - never use insecure defaults
# =============================================================================
- name: Validate keystore password is defined and secure
  ansible.builtin.assert:
    that:
      - liberty_keystore_password is defined
      - liberty_keystore_password | length >= 16
      - liberty_keystore_password != 'changeit'
      - liberty_keystore_password != 'password'
      - liberty_keystore_password != 'changeme'
      - liberty_keystore_password != 'liberty'
    fail_msg: >
      SECURITY ERROR: liberty_keystore_password must be defined with a strong password
      (minimum 16 characters). This value should be stored in Ansible Vault.
      Never use default passwords like 'changeit' in production.
      Example: ansible-vault encrypt_string 'YourStr0ng!P@ssw0rd#2024' --name 'liberty_keystore_password'

- name: Validate admin password is defined and secure
  ansible.builtin.assert:
    that:
      - liberty_admin_password is defined
      - liberty_admin_password | length >= 12
      - liberty_admin_password != 'admin'
      - liberty_admin_password != 'password'
      - liberty_admin_password != 'changeme'
      - liberty_admin_password != 'liberty'
    fail_msg: >
      SECURITY ERROR: liberty_admin_password must be defined with a strong password
      (minimum 12 characters). This value should be stored in Ansible Vault.
      Never use default passwords like 'admin' in production.
      Example: ansible-vault encrypt_string 'SecureAdm1n#2024' --name 'liberty_admin_password'

# Fetch database credentials from AWS Secrets Manager (optional)
# If AWS CLI is available and password not set, fetch from Secrets Manager
- name: Check if AWS CLI is available
  ansible.builtin.command:
    cmd: which aws
  register: aws_cli_check
  delegate_to: localhost
  become: false
  changed_when: false
  failed_when: false
  when:
    - env_name == 'production'
    - postgresql_host is defined
    - postgresql_password is not defined

- name: Fetch database credentials from Secrets Manager
  when:
    - env_name == 'production'
    - postgresql_host is defined
    - postgresql_password is not defined
    - aws_cli_check.rc is defined and aws_cli_check.rc == 0
  block:
    - name: Get database secret from AWS Secrets Manager
      ansible.builtin.command:
        cmd: >
          aws secretsmanager get-secret-value
          --secret-id mw-prod/database/credentials
          --query SecretString
          --output text
          --region {{ aws_region | default('us-east-1') }}
      register: db_secret_result
      changed_when: false
      delegate_to: localhost
      become: false
      no_log: true

    - name: Parse database credentials
      ansible.builtin.set_fact:
        postgresql_password: "{{ (db_secret_result.stdout | from_json).password }}"
        postgresql_user: "{{ (db_secret_result.stdout | from_json).username }}"
      no_log: true

- name: Warn if database password not available
  ansible.builtin.debug:
    msg: "WARNING: Database password not set. Set postgresql_password in inventory or ensure AWS CLI is available."
  when:
    - postgresql_host is defined
    - postgresql_password is not defined
    - aws_cli_check.rc is defined and aws_cli_check.rc != 0

# User and Directory Setup
- name: Create Liberty service account
  ansible.builtin.user:
    name: "{{ liberty_user }}"
    system: true
    shell: /bin/bash
    home: "/home/{{ liberty_user }}"
    createhome: true

- name: Create Liberty directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ liberty_user }}"
    group: "{{ liberty_user }}"
    mode: "0755"
  loop:
    - "{{ liberty_install_dir }}"
    - "/var/log/liberty"
    - "/var/liberty/apps"
    - "/var/liberty/config"

# Java Installation
- name: Install Java {{ liberty_java_version | default('17') }}
  ansible.builtin.package:
    name: "openjdk-{{ liberty_java_version | default('17') }}-jdk"
    state: present

- name: Set JAVA_HOME
  ansible.builtin.lineinfile:
    path: /etc/environment
    regexp: '^JAVA_HOME='
    line: "JAVA_HOME=/usr/lib/jvm/java-{{ liberty_java_version | default('17') }}-openjdk-amd64"

# Download and Install Liberty
- name: Check if Liberty is installed
  ansible.builtin.stat:
    path: "{{ liberty_install_dir }}/bin/server"
  register: liberty_installed

- name: Download Open Liberty
  ansible.builtin.get_url:
    url: "https://public.dhe.ibm.com/ibmdl/export/pub/software/openliberty/runtime/release/{{ liberty_version }}/openliberty-{{ liberty_version }}.zip"
    dest: "/tmp/openliberty-{{ liberty_version }}.zip"
    mode: "0644"
    timeout: 300
  when: not liberty_installed.stat.exists

- name: Extract Open Liberty
  ansible.builtin.unarchive:
    src: "/tmp/openliberty-{{ liberty_version }}.zip"
    dest: "{{ liberty_install_dir | dirname }}"
    remote_src: true
    owner: "{{ liberty_user }}"
    group: "{{ liberty_user }}"
  when: not liberty_installed.stat.exists
  notify: Restart Liberty

- name: Verify Liberty installation
  ansible.builtin.command:
    cmd: "{{ liberty_install_dir }}/bin/server version"
  register: liberty_version_output
  changed_when: false

# Create Server Instance
- name: Create Liberty server
  ansible.builtin.command:
    cmd: "{{ liberty_install_dir }}/bin/server create {{ liberty_server_name }}"
    creates: "{{ liberty_install_dir }}/usr/servers/{{ liberty_server_name }}"
  become: true
  become_user: "{{ liberty_user }}"

# =============================================================================
# SECURITY: Encode passwords before deploying server.xml
# Uses Liberty's securityUtility to AES-encode all passwords
# =============================================================================
- name: Encode passwords for secure deployment
  ansible.builtin.include_tasks: encode-passwords.yml

# Configure Server
- name: Deploy server.xml
  ansible.builtin.template:
    src: server.xml.j2
    dest: "{{ liberty_install_dir }}/usr/servers/{{ liberty_server_name }}/server.xml"
    owner: "{{ liberty_user }}"
    mode: "0640"
  notify: Restart Liberty
  no_log: true

- name: Deploy JVM options
  ansible.builtin.template:
    src: jvm.options.j2
    dest: "{{ liberty_install_dir }}/usr/servers/{{ liberty_server_name }}/jvm.options"
    owner: "{{ liberty_user }}"
    mode: "0640"
  notify: Restart Liberty

# Database Driver (PostgreSQL)
- name: Create JDBC directory
  ansible.builtin.file:
    path: "{{ liberty_install_dir }}/usr/servers/{{ liberty_server_name }}/jdbc"
    state: directory
    owner: "{{ liberty_user }}"
    group: "{{ liberty_user }}"
    mode: "0755"
  when: postgresql_host is defined and postgresql_host != ''

- name: Download PostgreSQL JDBC driver
  ansible.builtin.get_url:
    url: "https://jdbc.postgresql.org/download/postgresql-{{ postgresql_jdbc_version | default('42.7.1') }}.jar"
    dest: "{{ liberty_install_dir }}/usr/servers/{{ liberty_server_name }}/jdbc/postgresql-{{ postgresql_jdbc_version | default('42.7.1') }}.jar"
    owner: "{{ liberty_user }}"
    group: "{{ liberty_user }}"
    mode: "0644"
  when: postgresql_host is defined and postgresql_host != ''
  notify: Restart Liberty

# Redis/JCache Configuration
- name: Create JCache directory
  ansible.builtin.file:
    path: "{{ liberty_install_dir }}/usr/servers/{{ liberty_server_name }}/jcache"
    state: directory
    owner: "{{ liberty_user }}"
    group: "{{ liberty_user }}"
    mode: "0755"
  when: redis_host is defined and redis_host != ''

- name: Download Redisson JCache provider
  ansible.builtin.get_url:
    url: "https://repo1.maven.org/maven2/org/redisson/redisson-all/{{ redisson_version | default('3.24.3') }}/redisson-all-{{ redisson_version | default('3.24.3') }}.jar"
    dest: "{{ liberty_install_dir }}/usr/servers/{{ liberty_server_name }}/jcache/redisson-all-{{ redisson_version | default('3.24.3') }}.jar"
    owner: "{{ liberty_user }}"
    group: "{{ liberty_user }}"
    mode: "0644"
  when: redis_host is defined and redis_host != ''
  notify: Restart Liberty

- name: Deploy Redisson configuration
  ansible.builtin.template:
    src: redisson.yaml.j2
    dest: "{{ liberty_install_dir }}/usr/servers/{{ liberty_server_name }}/redisson.yaml"
    owner: "{{ liberty_user }}"
    group: "{{ liberty_user }}"
    mode: "0640"
  when: redis_host is defined and redis_host != ''
  notify: Restart Liberty

# SSL Certificates
- name: Create security directory
  ansible.builtin.file:
    path: "{{ liberty_install_dir }}/usr/servers/{{ liberty_server_name }}/resources/security"
    state: directory
    owner: "{{ liberty_user }}"
    mode: "0750"

- name: Generate SSL certificates
  ansible.builtin.command:
    cmd: >
      {{ liberty_install_dir }}/bin/securityUtility createSSLCertificate
      --server={{ liberty_server_name }}
      --password={{ liberty_keystore_password }}
      --validity=365
    creates: "{{ liberty_install_dir }}/usr/servers/{{ liberty_server_name }}/resources/security/key.p12"
  become: true
  become_user: "{{ liberty_user }}"
  no_log: true

# Systemd Service
- name: Deploy systemd service
  ansible.builtin.template:
    src: liberty.service.j2
    dest: "/etc/systemd/system/liberty-{{ liberty_server_name }}.service"
    mode: "0644"
  notify:
    - Reload systemd
    - Restart Liberty

- name: Enable and start Liberty
  ansible.builtin.systemd:
    name: "liberty-{{ liberty_server_name }}"
    enabled: true
    state: started
    daemon_reload: true

- name: Wait for Liberty to be ready
  ansible.builtin.uri:
    url: "http://localhost:{{ liberty_http_port | default(9080) }}/health/ready"
    status_code: 200
  register: liberty_health
  retries: 12
  delay: 10
  until: liberty_health.status == 200
