---
# =============================================================================
# Liberty Password Encoding Tasks
# =============================================================================
# Uses Liberty's securityUtility to encode passwords with AES encryption
# This ensures no plaintext passwords are written to server.xml
# =============================================================================

- name: Encode keystore password using Liberty securityUtility
  ansible.builtin.command:
    argv:
      - "{{ liberty_install_dir }}/bin/securityUtility"
      - encode
      - --encoding=aes
      - "{{ liberty_keystore_password }}"
  register: encoded_keystore_result
  changed_when: false
  no_log: true

- name: Validate keystore password encoding succeeded
  ansible.builtin.assert:
    that:
      - encoded_keystore_result.rc == 0
      - encoded_keystore_result.stdout | length > 0
    fail_msg: "Failed to encode keystore password using securityUtility"
  no_log: true

- name: Set encoded keystore password fact
  ansible.builtin.set_fact:
    liberty_keystore_password_encoded: "{{ encoded_keystore_result.stdout | trim }}"
  no_log: true

- name: Encode admin password using Liberty securityUtility
  ansible.builtin.command:
    argv:
      - "{{ liberty_install_dir }}/bin/securityUtility"
      - encode
      - --encoding=aes
      - "{{ liberty_admin_password }}"
  register: encoded_admin_result
  changed_when: false
  no_log: true

- name: Validate admin password encoding succeeded
  ansible.builtin.assert:
    that:
      - encoded_admin_result.rc == 0
      - encoded_admin_result.stdout | length > 0
    fail_msg: "Failed to encode admin password using securityUtility"
  no_log: true

- name: Set encoded admin password fact
  ansible.builtin.set_fact:
    liberty_admin_password_encoded: "{{ encoded_admin_result.stdout | trim }}"
  no_log: true

- name: Encode database password using Liberty securityUtility
  ansible.builtin.command:
    argv:
      - "{{ liberty_install_dir }}/bin/securityUtility"
      - encode
      - --encoding=aes
      - "{{ postgresql_password }}"
  register: encoded_db_result
  changed_when: false
  no_log: true
  when: postgresql_password is defined and postgresql_password != ''

- name: Validate database password encoding succeeded
  ansible.builtin.assert:
    that:
      - encoded_db_result.rc == 0
      - encoded_db_result.stdout | length > 0
    fail_msg: "Failed to encode database password using securityUtility"
  no_log: true
  when: postgresql_password is defined and postgresql_password != ''

- name: Set encoded database password fact
  ansible.builtin.set_fact:
    postgresql_password_encoded: "{{ encoded_db_result.stdout | trim }}"
  no_log: true
  when: postgresql_password is defined and postgresql_password != ''

- name: Set empty database password if not defined
  ansible.builtin.set_fact:
    postgresql_password_encoded: ""
  when: postgresql_password is not defined or postgresql_password == ''
