# =============================================================================
# AlertManager Configuration - Generated by Ansible
# =============================================================================
# Template: alertmanager.yml.j2
# Deployed to: {{ alertmanager_config_dir }}/alertmanager.yml
#
# Webhook Configuration:
#   Slack webhook is read from: {{ alertmanager_secrets_dir }}/slack-webhook
#   To update: echo 'https://hooks.slack.com/...' > {{ alertmanager_secrets_dir }}/slack-webhook
# =============================================================================

global:
  resolve_timeout: 5m
{% if alertmanager_slack_webhook_url | length > 0 %}
  # Slack webhook configured via Ansible variable
  slack_api_url_file: '{{ alertmanager_secrets_dir }}/slack-webhook'
{% else %}
  # WARNING: No Slack webhook configured
  # Notifications will NOT be sent until you configure:
  #   1. Set ALERTMANAGER_SLACK_WEBHOOK_URL environment variable, OR
  #   2. Create {{ alertmanager_secrets_dir }}/slack-webhook file, OR
  #   3. Pass -e "alertmanager_slack_webhook_url=..." to ansible-playbook
{% endif %}

route:
  receiver: 'default'
  group_by: ['alertname', 'severity']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h

  routes:
    # Critical alerts - immediate notification
    - receiver: 'critical'
      match:
        severity: critical
      continue: false

    # Warning alerts
    - receiver: 'warning'
      match:
        severity: warning
      continue: false

receivers:
  # Default receiver for unmatched alerts
  - name: 'default'
{% if alertmanager_slack_webhook_url | length > 0 %}
    slack_configs:
      - channel: '{{ alertmanager_slack_channel_default }}'
        send_resolved: true
        title: '{{ '{{' }} .Status | toUpper {{ '}}' }}: {{ '{{' }} .CommonLabels.alertname {{ '}}' }}'
        text: >-
          {{ '{{' }} range .Alerts {{ '}}' }}
          *Alert:* {{ '{{' }} .Labels.alertname {{ '}}' }}
          *Severity:* {{ '{{' }} .Labels.severity | default "info" {{ '}}' }}
          *Instance:* {{ '{{' }} .Labels.instance | default "N/A" {{ '}}' }}
          *Description:* {{ '{{' }} .Annotations.description | default .Annotations.summary | default "No description" {{ '}}' }}
          {{ '{{' }} end {{ '}}' }}
{% endif %}

  # Critical alerts - high priority
  - name: 'critical'
{% if alertmanager_slack_webhook_url | length > 0 %}
    slack_configs:
      - channel: '{{ alertmanager_slack_channel_critical }}'
        send_resolved: true
        color: '{{ '{{' }} if eq .Status "firing" {{ '}}' }}danger{{ '{{' }} else {{ '}}' }}good{{ '{{' }} end {{ '}}' }}'
        title: 'CRITICAL: {{ '{{' }} .CommonLabels.alertname {{ '}}' }}'
        text: >-
          {{ '{{' }} range .Alerts {{ '}}' }}
          *Alert:* {{ '{{' }} .Labels.alertname {{ '}}' }}
          *Instance:* {{ '{{' }} .Labels.instance | default "N/A" {{ '}}' }}
          *Job:* {{ '{{' }} .Labels.job | default "N/A" {{ '}}' }}
          *Description:* {{ '{{' }} .Annotations.description | default .Annotations.summary | default "No description" {{ '}}' }}
          *Runbook:* {{ '{{' }} .Annotations.runbook_url | default "N/A" {{ '}}' }}
          {{ '{{' }} end {{ '}}' }}
{% endif %}
{% if alertmanager_pagerduty_key | length > 0 %}
    pagerduty_configs:
      - service_key_file: '{{ alertmanager_secrets_dir }}/pagerduty-key'
        severity: '{{ '{{' }} .CommonLabels.severity {{ '}}' }}'
        description: '{{ '{{' }} .CommonAnnotations.summary {{ '}}' }}'
{% endif %}

  # Warning alerts
  - name: 'warning'
{% if alertmanager_slack_webhook_url | length > 0 %}
    slack_configs:
      - channel: '{{ alertmanager_slack_channel_default }}'
        send_resolved: true
        color: 'warning'
        title: 'WARNING: {{ '{{' }} .CommonLabels.alertname {{ '}}' }}'
        text: >-
          {{ '{{' }} range .Alerts {{ '}}' }}
          *Alert:* {{ '{{' }} .Labels.alertname {{ '}}' }}
          *Instance:* {{ '{{' }} .Labels.instance | default "N/A" {{ '}}' }}
          *Description:* {{ '{{' }} .Annotations.description | default .Annotations.summary | default "No description" {{ '}}' }}
          {{ '{{' }} end {{ '}}' }}
{% endif %}

  # Null receiver for silencing alerts
  - name: 'null'

# Inhibition rules reduce alert noise
inhibit_rules:
  # If server is down, suppress all Liberty alerts for same instance
  - source_match:
      alertname: 'LibertyServerDown'
    target_match_re:
      alertname: 'Liberty.*'
    equal: ['instance']

  # If no ECS tasks, suppress individual task alerts
  - source_match:
      alertname: 'ECSLibertyNoTasks'
    target_match:
      alertname: 'ECSLibertyTaskDown'
    equal: ['job']

  # Critical suppresses warning for same alertname
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname']
