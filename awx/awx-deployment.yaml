---
apiVersion: v1
kind: Namespace
metadata:
  name: awx

---
apiVersion: awx.ansible.com/v1beta1
kind: AWX
metadata:
  name: awx
  namespace: awx
spec:
  service_type: LoadBalancer
  
  web_resource_requirements:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi
  
  postgres_storage_class: longhorn
  postgres_storage_requirements:
    requests:
      storage: 10Gi
  
  projects_persistence: true
  projects_storage_class: longhorn
  projects_storage_size: 5Gi
  
  admin_user: admin
  admin_password_secret: awx-admin-password

# =============================================================================
# SECURITY NOTE: AWX Admin Password Secret
# =============================================================================
# The awx-admin-password secret MUST be created separately before deploying AWX.
# DO NOT store passwords in version control.
#
# Option 1: Create secret directly with kubectl
#   kubectl create secret generic awx-admin-password \
#     --namespace=awx \
#     --from-literal=password='YOUR_SECURE_PASSWORD_HERE'
#
# Option 2: Use Sealed Secrets (recommended for GitOps)
#   kubeseal --format=yaml < awx-admin-password-secret.yaml > awx-admin-password-sealed.yaml
#
# Option 3: Use External Secrets Operator with AWS Secrets Manager/HashiCorp Vault
#   apiVersion: external-secrets.io/v1beta1
#   kind: ExternalSecret
#   metadata:
#     name: awx-admin-password
#     namespace: awx
#   spec:
#     refreshInterval: 1h
#     secretStoreRef:
#       name: vault-backend
#       kind: ClusterSecretStore
#     target:
#       name: awx-admin-password
#     data:
#       - secretKey: password
#         remoteRef:
#           key: awx/admin
#           property: password
#
# The secret must contain a 'password' key with the admin password value.
# =============================================================================

---
apiVersion: v1
kind: Service
metadata:
  name: awx-lb
  namespace: awx
  annotations:
    metallb.universe.tf/loadBalancerIPs: "192.168.68.205"
spec:
  type: LoadBalancer
  selector:
    app.kubernetes.io/name: awx-web
  ports:
    - port: 80
      targetPort: 8052
